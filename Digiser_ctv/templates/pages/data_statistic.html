{% extends 'bases/base.html' %}
{% block content %}

<style>
    .modal-header {
        background-color: #007bff;
        color: white;
        border-bottom: none;
    }

    .modal-header .close {
        color: white;
    }

    .modal-title {
        font-size: 1.5em;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-content {
        border-radius: 10px;
        overflow: hidden;
    }

    .modal-footer {
        border-top: none;
        padding: 10px 20px;
        text-align: right;
    }

    .btn-primary {
        background-color: #007bff;
        border: none;
    }

    .btn-primary:hover {
        background-color: #0056b3;
    }

    .filter-section {
        margin-bottom: 20px;
    }

    .filter-section label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .filter-section .btn-group {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .filter-section .btn-group .btn {
        flex: 1;
        margin: 0 5px;
    }

    .filter-section .date-picker {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .filter-section .date-picker input {
        flex: 1;
        margin-right: 10px;
    }

    .filter-section .date-picker label {
        margin-right: 10px;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }

    .table th {
        background-color: #cecece;
        color: black;
        font-weight: 500;
    }

    .table th,
    .table td {
        border: 1px solid #c7c7c7;
        padding: 8px;
        overflow: hidden;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: small;
        vertical-align: middle;
    }

    .table .toggle {
        font-weight: bold;
        cursor: pointer;
        vertical-align: middle;
        line-height: 1.25;
    }

    .table tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .table tr:hover {
        background-color: #ddd;
    }

    .badge {
        padding: 5px 10px;
        border-radius: 5px;
        display: inline-block;
        width: 100px;
        text-align: center;
    }

    .bg-primary {
        background-color: #007bff;
        color: white;
    }

    .bg-warning {
        background-color: #ffc107;
        color: black;
    }

    .bg-danger {
        background-color: #dc3545;
        color: white;
    }

    .bg-success {
        background-color: #28a745;
        color: white;
    }

    .bg-default {
        background-color: #6c757d;
        color: white;
    }

    .table th:nth-child(1),
    .table td:nth-child(1) {
        width: 5%;
    }

    .table th:nth-child(2),
    .table td:nth-child(2) {
        width: 20%;
    }

    .table th:nth-child(3),
    .table td:nth-child(3) {
        width: 10%;
    }

    .table th:nth-child(4),
    .table td:nth-child(4) {
        width: 10%;
    }

    .table th:nth-child(5),
    .table td:nth-child(5) {
        width: 15%;
    }

    .table th:nth-child(6),
    .table td:nth-child(6) {
        width: 10%;
    }

    .table th:nth-child(7),
    .table td:nth-child(7) {
        width: 10%;
    }

    .table th:nth-child(8),
    .table td:nth-child(8) {
        width: 10%;
    }

    .table th:nth-child(9),
    .table td:nth-child(9) {
        width: 5%;
    }

    .table th:nth-child(10),
    .table td:nth-child(10) {
        width: 5%;
    }

    .toggle-icon {
        margin-right: 10px;
        font-size: 1.5em;
        vertical-align: middle;
    }
</style>

<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
    <i class='bx bx-filter-alt'></i> Lọc
</button>

<!-- Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Lọc dữ liệu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Filter form content -->
                <form id="filter-form">
                    <div class="filter-section">
                        <label>Trạng thái</label>
                        <div class="btn-group" role="group" aria-label="Trạng thái">
                            <button type="button" class="btn btn-outline-primary" data-value="Hoàn thành">Hoàn thành</button>
                            <button type="button" class="btn btn-outline-warning" data-value="Chưa nhập">Chưa nhập</button>
                            <button type="button" class="btn btn-outline-danger" data-value="Báo lỗi">Báo lỗi</button>
                        </div>
                    </div>
                    <div class="filter-section">
                        <label>Loại tài liệu</label>
                        <div class="btn-group" role="group" aria-label="Loại tài liệu">
                            <button type="button" class="btn btn-outline-secondary" data-value="CMC">CMC</button>
                            <button type="button" class="btn btn-outline-secondary" data-value="HN">HN</button>
                            <button type="button" class="btn btn-outline-secondary" data-value="KT">KT</button>
                            <button type="button" class="btn btn-outline-secondary" data-value="KS">KS</button>
                            <button type="button" class="btn btn-outline-secondary" data-value="KH">KH</button>
                        </div>
                    </div>
                    <div class="filter-section">
                        <label>Khu vực</label>
                        <div class="btn-group" role="group" aria-label="Khu vực">
                            <button type="button" class="btn btn-outline-secondary" data-value="Tp Hồ Chí Minh">Tp Hồ Chí Minh</button>
                            <button type="button" class="btn btn-outline-secondary" data-value="Tiền Giang">Tiền Giang</button>
                            <button type="button" class="btn btn-outline-secondary" data-value="Bến Tre">Bến Tre</button>
                        </div>
                    </div>
                    <div class="filter-section date-picker">
                        <label for="received_date">Thời gian nhận</label>
                        <input type="date" class="form-control" id="received_date" name="received_date">
                    </div>
                    <div class="filter-section date-picker">
                        <label for="deadline">Deadline</label>
                        <input type="date" class="form-control" id="deadline" name="deadline">
                    </div>
                    <button type="button" class="btn btn-primary" id="apply-filter">Lọc</button>
                </form>
            </div>
        </div>
    </div>
</div>




<table class="table table-hover table-bordered mt-3">
    <thead class="thead-light">
        <tr>
            <th>ID</th>
            <th class="tong_phieu">Tên dữ liệu</th>
            <th class="so_phieu">Số phiếu</th>
            <th class="so_truong">Số trường</th>
            <th class="thuc_hien">Thực hiện</th>
            <th class="trang_thai">Trạng thái</th>
            <th class="ngay_nhan">Ngày nhận</th>
            <th class="deadline">Deadline</th>
            <th class="so_loi">Số lỗi</th>
            <th class="loai_file">Loại file</th>
        </tr>
    </thead>
    <tbody>
        {% for project in page_obj %}
        <tr class="parent toggle" data-id="{{ forloop.counter }}">
            <td>{{ forloop.counter }}</td>
            <td colspan="1">
                <i class='bx bx-chevron-right toggle-icon'></i>{{ project.name }}
            </td>
            <td class="tong_phieu">{{ project.tong_phieu }}</td>
            <td class="tong_truong"></td>
            <td class="thuc_hien">{{ project.thuc_hien }}</td>
            <td class="trang_thai">
                <span class="badge 
                    {% if project.trang_thai == 'Đã nhập' %} bg-primary 
                    {% elif project.trang_thai == 'Chưa check' %} bg-warning 
                    {% elif project.trang_thai == 'Báo lỗi' %} bg-danger 
                    {% elif project.trang_thai == 'Hoàn thành' %} bg-success 
                    {% else %} bg-default 
                    {% endif %}">
                    {{ project.trang_thai }}
                </span>
            </td>
            <td class="ngay_nhan">{{ project.ngay_nhan }}</td>
            <td class="deadline">{{ project.deadline }}</td>
            <td class="so_loi"></td>
            <td class="loai_file"></td>
        </tr>
        {% for record in project.datarecord_set %}
        <tr class="child" data-parent="{{ forloop.parentloop.counter }}" style="display: none;">
            <td></td>
            <td class="ten_du_lieu">{{ record.ten_du_lieu }}</td>
            <td class="tong_phieu">{{ record.tong_phieu }}</td>
            <td class="tong_truong">{{ record.tong_truong }}</td>
            <td class="thuc_hien">{{ record.thuc_hien }}</td>
            <td class="trang_thai">
                <span class="badge 
                    {% if record.trang_thai == 'Đã nhập' %} bg-primary 
                    {% elif record.trang_thai == 'Chưa check' %} bg-warning 
                    {% elif record.trang_thai == 'Báo lỗi' %} bg-danger 
                    {% elif record.trang_thai == 'Hoàn thành' %} bg-success 
                    {% else %} bg-default 
                    {% endif %}">
                    {{ record.trang_thai }}
                </span>
            </td>
            <td class="ngay_nhan">{{ record.ngay_nhan }}</td>
            <td class="deadline">{{ record.deadline }}</td>
            <td class="so_loi">{{ record.so_loi }}</td>
            <td class="loai_file">{{ record.loai_file }}</td>
        </tr>
        {% endfor %}
        {% endfor %}
    </tbody>
</table>

<div class="pagination-container">
    <form method="get" id="pagination-form">
        <label for="records-per-page">Hiển thị</label>
        <select id="records-per-page" name="records_per_page" onchange="this.form.submit();">
            <option value="5" {% if records_per_page == '5' %}selected{% endif %}>5</option>
            <option value="10" {% if records_per_page == '10' %}selected{% endif %}>10</option>
            <option value="20" {% if records_per_page == '20' %}selected{% endif %}>20</option>
        </select>
        <span>bản ghi</span>
    </form>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
    // Select all elements with the class 'toggle'
    var toggles = document.querySelectorAll('.toggle');
    
    // Iterate over each toggle element
    toggles.forEach(function (toggle) {
        toggle.addEventListener('click', function () {
            // Get the parent ID from the clicked element
            var parentId = this.getAttribute('data-id');
            console.log('Parent ID:', parentId); // Debugging log
            
            // Select all children rows with the matching data-parent attribute
            var children = document.querySelectorAll('.child[data-parent="' + parentId + '"]');
            var icon = this.querySelector('.toggle-icon');
            console.log('Children elements:', children); // Debugging log
            
            // Toggle visibility for each child row
            children.forEach(function (child) {
                if (child.style.display === 'none' || child.style.display === '') {
                    child.style.display = 'table-row';
                    icon.className = 'bx bx-chevron-down toggle-icon';
                } else {
                    child.style.display = 'none';
                    icon.className = 'bx bx-chevron-right toggle-icon';
                }
            });
            this.classList.toggle('expanded');
        });
    });
});

document.addEventListener('DOMContentLoaded', function () {
    // Lắng nghe sự kiện click trên nút "Lọc"
    document.getElementById('apply-filter').addEventListener('click', function() {
        // Lấy giá trị từ các nút trong modal
        var selectedStatus = [];
        document.querySelectorAll('.filter-section .btn-group button').forEach(function(btn) {
            if (btn.classList.contains('active')) {
                selectedStatus.push(btn.getAttribute('data-value'));
            }
        });

        // Lấy giá trị từ các input ngày tháng
        var receivedDate = document.getElementById('received_date').value;
        var deadlineDate = document.getElementById('deadline').value;

        // Duyệt qua các hàng trong bảng và ẩn/hiện dựa trên giá trị đã chọn
        document.querySelectorAll('tbody tr.parent').forEach(function(row) {
            var status = row.querySelector('.trang_thai').textContent.trim();
            var dateReceived = row.querySelector('.ngay_nhan').textContent.trim();
            var dateDeadline = row.querySelector('.deadline').textContent.trim();

            var showRow = true;

            if (selectedStatus.length > 0 && !selectedStatus.includes(status)) {
                showRow = false;
            }

            if (receivedDate && dateReceived !== receivedDate) {
                showRow = false;
            }

            if (deadlineDate && dateDeadline !== deadlineDate) {
                showRow = false;
            }

            row.style.display = showRow ? '' : 'none';
        });

        // Đóng modal sau khi áp dụng bộ lọc
        var filterModal = document.getElementById('filterModal');
        var modalInstance = bootstrap.Modal.getInstance(filterModal);
        modalInstance.hide();
    });

    // Cho phép nhấn nút và đổi trạng thái active
    document.querySelectorAll('.filter-section .btn-group button').forEach(function(btn) {
        btn.addEventListener('click', function() {
            btn.classList.toggle('active');
        });
    });
});



</script>
{% endblock %}