{% extends 'bases/base.html' %}
{% block content %}

<style>
.modal-dialog {
    max-width: 1000px; /* Increase the max-width to accommodate the content */
    margin: 1.75rem auto; /* Center the modal on the screen */
}
.modal-content {
    border-radius: 15px;
    box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1);
    padding: 20px;
    background-color: #fff;
}

.modal-header {
    background-color: #cecece;
    color: black;
    border-bottom: 1px solid #ddd;
    border-radius: 15px 15px 0 0;
    padding: 15px;
    font-size: 1.2em;
    font-weight: bold;
}

.modal-header .btn-close {
    color: black;
}

.modal-body {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Two equal-width columns for labels */
    gap: 10px; /* Space between the columns */
    padding: 20px;
    font-size: 1em;
}

.filter-section {
    display: flex;
    flex-direction: column;
    gap: 5px; /* Space between label and buttons/inputs */
}

.filter-section .btn-group,
.filter-section .date-picker {
    display: flex;
    justify-content: flex-start;
    gap: 10px; /* Space between buttons/inputs */
}

.filter-section .btn-group .btn,
.filter-section .date-picker  {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    text-align: center;
}

.filter-section .btn-group {
    display: flex;
    flex-wrap: wrap; /* Allow buttons to wrap to the next line */
    gap: 10px; /* Space between buttons */
}

.filter-section .btn-group .btn {
    flex: 1 1 calc(33.33% - 10px); /* 3 buttons per row with space between them */
    margin-bottom: 10px; /* Add some space below each row of buttons */
    text-align: center;
}



.filter-section.full-width .btn-group .btn {
    flex-basis: calc(33.33%); /* Ensure a maximum of 3 buttons per row */
}


.filter-section.full-width {
    grid-column: span 2; /* Span across both columns for full-width sections */
}

.modal-footer {
    border-top: none;
    padding: 10px 20px;
    text-align: right;
    background-color: #f9f9f9;
    border-radius: 0 0 15px 15px;
}

.btn-primary {
    padding: 10px 24px;
    display: flex;
    align-items: center;
    column-gap: 6px;
    background-color: var(--button-color);
    color: white;
    border: none; 
    border-radius: 4px; 
    box-shadow: 0 0 10px rgba(69, 69, 233, 0.3); 
    transition: var(--tran-03);
}

    .btn-primary:hover {
        background-color: #0056b3;
    }
    .filter-section .date-picker label {
        margin-right: 10px;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }

    .table th {
        background-color: #cecece;
        color: black;
        font-weight: 500;
    }

    .table th,
    .table td {
        border: 1px solid #c7c7c7;
        padding: 8px;
        overflow: hidden;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: small;
        vertical-align: middle;
    }

    .table .toggle {
        font-weight: bold;
        cursor: pointer;
        vertical-align: middle;
        line-height: 1.25;
    }

    .table tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .table tr:hover {
        background-color: #ddd;
    }

    .badge {
        padding: 5px 10px;
        border-radius: 5px;
        display: inline-block;
        width: 100px;
        text-align: center;
    }

    .bg-primary {
        background-color: #007bff;
        color: white;
    }

    .bg-warning {
        background-color: #ffc107;
        color: black;
    }

    .bg-danger {
        background-color: #dc3545;
        color: white;
    }

    .bg-success {
        background-color: #28a745;
        color: white;
    }

    .bg-default {
        background-color: #6c757d;
        color: white;
    }

    .table th:nth-child(1),
    .table td:nth-child(1) {
        width: 5%;
    }

    .table th:nth-child(2),
    .table td:nth-child(2) {
        width: 20%;
    }

    .table th:nth-child(3),
    .table td:nth-child(3) {
        width: 10%;
    }

    .table th:nth-child(4),
    .table td:nth-child(4) {
        width: 10%;
    }

    .table th:nth-child(5),
    .table td:nth-child(5) {
        width: 15%;
    }

    .table th:nth-child(6),
    .table td:nth-child(6) {
        width: 10%;
    }

    .table th:nth-child(7),
    .table td:nth-child(7) {
        width: 10%;
    }

    .table th:nth-child(8),
    .table td:nth-child(8) {
        width: 10%;
    }

    .table th:nth-child(9),
    .table td:nth-child(9) {
        width: 5%;
    }

    .table th:nth-child(10),
    .table td:nth-child(10) {
        width: 5%;
    }

    .toggle-icon {
        margin-right: 10px;
        font-size: 1.5em;
        vertical-align: middle;
    }

    .pagination-container {
    display: flex;
    justify-content: space-between;
    background-color:#c7c7c7;
    align-items: center;
    margin-top: 20px;
    font-size: 14px;
    padding: 5px;
    color: #333;
    font-weight: bold;
    padding-left: 50px;
    padding-right: 50px;
}

.pagination-container select {
    margin-left: 10px;
    padding: 3px;
    font-size: 14px;
    border: 1px solid #ccc;
}

.pagination-container span {
    margin-left: 5px;
}

.pagination-container .total-records {
    font-weight: bold;
    color: #333;
}

.table-container {
    width: 100%;
    border-collapse: collapse;
    overflow: hidden;
}


</style>

<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
    <i class='bx bx-filter-alt'></i> Lọc
</button>

<!-- Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Lọc dữ liệu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- First row: Trạng thái and Loại tài liệu labels -->
                <div class="filter-section">
                    <label>Trạng thái</label>
                    <div class="btn-group" role="group" aria-label="Trạng thái">
                        <button type="button" class="btn btn-outline-primary" data-value="Hoàn thành">Hoàn thành</button>
                        <button type="button" class="btn btn-outline-warning" data-value="Chưa nhập">Chưa nhập</button>
                    </div>
                </div>
                <div class="filter-section">
                    <label>Loại tài liệu</label>
                    <div class="btn-group" role="group" aria-label="Loại tài liệu">
                        <button type="button" class="btn btn-outline-secondary" data-value="CMC">CMC</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="HN">HN</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="KT">KT</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="KS">KS</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="KH">KH</button>
                    </div>
                </div>
            
                <!-- Second row: Thời gian nhận and Deadline -->
                <div class="filter-section">
                    <label for="received_date">Thời gian nhận</label>
                    <div class="date-picker">
                        <input type="date" class="form-control" id="received_date" name="received_date">
                    </div>
                </div>
                <div class="filter-section">
                    <label for="deadline">Deadline</label>
                    <div class="date-picker">
                        <input type="date" class="form-control" id="deadline" name="deadline">
                    </div>
                </div>
            
                <!-- Third row: Khu vực -->
                <div class="filter-section full-width">
                    <label>Khu vực</label>
                    <div class="btn-group" role="group" aria-label="Khu vực">
                        <button type="button" class="btn btn-outline-secondary" data-value="Tp Hồ Chí Minh">Tp Hồ Chí Minh</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="Tiền Giang">Tiền Giang</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="Bến Tre">Bến Tre</button>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-primary">Lọc</button>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}
<div class="table-container">
    <table class="table table-hover table-bordered mt-3">
        <thead class="thead-light">
            <tr>
                <th>ID</th>
                <th class="tong_phieu">Tên dữ liệu</th>
                <th class="so_phieu">Số phiếu</th>
                <th class="so_truong">Số trường</th>
                <th class="loai_cv">Loại công việc</th>
                <th class="trang_thai">Trạng thái</th>
                <th class="ngay_nhan">Ngày nhận</th>
                <th class="deadline">Deadline</th>
                <th class="so_loi">Số lỗi</th>
                <th class="loai_file">Loại file</th>
            </tr>
        </thead>
        <tbody>
            {% for package in packages %}
            <tr class="parent toggle" data-id="{{ forloop.counter }}">
                <td>{{ forloop.counter }}</td>
                <td colspan="1">
                    <i class='bx bx-chevron-right toggle-icon'></i>{{ package.package }}
                </td>
                <td class="tong_phieu">{{ package.total_tickets }}</td>
                <td class="tong_truong"></td>
                <td class="loai_cv">{{ package.executor }}</td>
                <td class="trang_thai">
                    <span class="badge 
                        {% if package.status_package == 'Đã nhập' %} bg-primary 
                        {% elif ppackage.status_package == 'Chưa check' %} bg-warning 
                        {% elif package.status_package == 'Báo lỗi' %} bg-danger 
                        {% elif package.status_package == 'Hoàn thành' %} bg-success 
                        {% else %} bg-default 
                        {% endif %}">
                        {{ package.status_package }}
                    </span>
                </td>
                <td>{{ package.received_day }}</td>
                <td>{{ package.deadline_day }}</td>
                <td></td>
                <td></td>
            </tr>
            {% for record in package.datarecord_set %}
            <tr class="child" data-parent="{{ forloop.parentloop.counter }}" style="display: none;">
                <td></td> <!-- Cột ID cho bản ghi con -->
                <td class="ten_du_lieu">{{ record.ten_du_lieu }}</td> <!-- Tên dữ liệu -->
                <td class="document-handle tong_phieu" onclick="openDocument('{{ record.parent }}', {{ forloop.counter0 }})" style="cursor: pointer;">
                    {{ record.document_name }}
                </td> <!-- Số phiếu -->
                <td class="tong_truong">{{ record.fields }}</td> <!-- Số trường -->
                <td class="loai_cv"></td> <!-- Cột Loại công việc, để trống -->
                <td class="trang_thai">
                    <span class="badge 
                        {% if record.status == 'Đã nhập' %} bg-primary 
                        {% elif record.status == 'Chưa check' %} bg-warning 
                        {% elif record.status == 'Báo lỗi' %} bg-danger 
                        {% elif record.status == 'Hoàn thành' %} bg-success 
                        {% else %} bg-default 
                        {% endif %}">
                        {{ record.status }}
                    </span>
                </td> <!-- Trạng thái -->
                <td class="ngay_nhan"></td> <!-- Ngày nhận -->
                <td class="deadline"></td> <!-- Deadline -->
                <td class="so_loi">{{ record.errors }}</td> <!-- Số lỗi -->
                <td class="loai_file">{{ record.type }}</td> <!-- Loại file -->
            </tr>
            {% endfor %}
            {% endfor %}
        </tbody>
    </table>
    <div class="pagination-container">    
        <div class="total-records">
            Có tổng {{ packages.paginator.count }} bản ghi
        </div>
        <form method="get" id="pagination-form" style="display: flex; align-items: center;">
            <label for="records-per-page">Hiển thị</label>
            <select id="records-per-page" name="records_per_page" onchange="this.form.submit();">
                <option value="5" {% if records_per_page == '5' %}selected{% endif %}>5</option>
                <option value="10" {% if records_per_page == '10' %}selected{% endif %}>10</option>
                <option value="20" {% if records_per_page == '20' %}selected{% endif %}>20</option>
            </select>
            <span>bản ghi</span>
        </form>
    </div>
</div>

<script>

    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    function openDocument(package_name, idx) {
        $.ajax({
            url: '/document/redirect',  // Relative URL
            type: 'POST',
            data: {
                package_name: package_name,
                idx: idx
            },
            headers: {
                'X-CSRFToken': getCsrfToken()  // Add CSRF token to the request header
            },
            success: function(response) {
                if (response.redirect_url) {
                    // Redirect the browser to the URL provided in the JSON response
                    window.location.href = response.redirect_url;
                } else {
                    console.log("Response received but no redirect_url found:", response);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error:", error);
            }
        });
    }

document.addEventListener('DOMContentLoaded', function () {
    // Select all elements with the class 'toggle'
    var toggles = document.querySelectorAll('.toggle');
    
    // Iterate over each toggle element
    toggles.forEach(function (toggle) {
        toggle.addEventListener('click', function () {
            // Get the parent ID from the clicked element
            var parentId = this.getAttribute('data-id');
            console.log('Parent ID:', parentId); // Debugging log
            
            // Select all children rows with the matching data-parent attribute
            var children = document.querySelectorAll('.child[data-parent="' + parentId + '"]');
            var icon = this.querySelector('.toggle-icon');
            console.log('Children elements:', children); // Debugging log
            
            // Toggle visibility for each child row
            children.forEach(function (child) {
                if (child.style.display === 'none' || child.style.display === '') {
                    child.style.display = 'table-row';
                    icon.className = 'bx bx-chevron-down toggle-icon';
                } else {
                    child.style.display = 'none';
                    icon.className = 'bx bx-chevron-right toggle-icon';
                }
            });
            this.classList.toggle('expanded');
        });
    });
});

document.addEventListener('DOMContentLoaded', function () {
    // Lắng nghe sự kiện click trên nút "Lọc"
    document.getElementById('apply-filter').addEventListener('click', function() {
        // Lấy giá trị từ các nút trong modal
        var selectedStatus = [];
        document.querySelectorAll('.filter-section .btn-group button').forEach(function(btn) {
            if (btn.classList.contains('active')) {
                selectedStatus.push(btn.getAttribute('data-value'));
            }
        });

        var receivedDate = document.getElementById('received_date').value;
        var deadlineDate = document.getElementById('deadline').value;

        document.querySelectorAll('tbody tr.parent').forEach(function(row) {
            var status = row.querySelector('.trang_thai').textContent.trim();
            var dateReceived = row.querySelector('.ngay_nhan').textContent.trim();
            var dateDeadline = row.querySelector('.deadline').textContent.trim();

            var showRow = true;

            if (selectedStatus.length > 0 && !selectedStatus.includes(status)) {
                showRow = false;
            }

            if (receivedDate && dateReceived !== receivedDate) {
                showRow = false;
            }

            if (deadlineDate && dateDeadline !== deadlineDate) {
                showRow = false;
            }

            row.style.display = showRow ? '' : 'none';
        });

        // Đóng modal sau khi áp dụng bộ lọc
        var filterModal = document.getElementById('filterModal');
        var modalInstance = bootstrap.Modal.getInstance(filterModal);
        modalInstance.hide();
    });

    // Cho phép nhấn nút và đổi trạng thái active
    document.querySelectorAll('.filter-section .btn-group button').forEach(function(btn) {
        btn.addEventListener('click', function() {
            btn.classList.toggle('active');
        });
    });
});



</script>
{% endblock %}